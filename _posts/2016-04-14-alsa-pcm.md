---
layout: "post"
title: "ALSA - PCM接口"
categories:
- "alsa"
---

<!--more-->

***
Table of Content

* TOC
{:toc}
***

*本文大部分内容来自ALSA官网的"[PCM Interface](http://www.alsa-project.org/alsa-doc/alsa-lib/pcm.html)"*

# 0. PCM

**Pulse-code modulation(PCM)**是用于将模拟信号表示为数字信号的一种方法。它是计算机,CD,数字电话以及其他数字音频设备对数字音频信号的标准表示法。在一个PCM流当中，模拟信号是按照一定间隔（采样周期）进行采集，每个采样点的采样值则被近似地量化为最接近的一个值（由采样深度决定）。

**Linear pulse-code-modulation(LPCM)**
是PCM中的一种类型。这种类型的量化值与模拟信号强度（响度）是呈线性关系。

**Non-linear pulse-code-modulation**
与LPCM不同，它的量化值相对与模拟信号强度呈非线性关系。例如：u-law, A-law等。

一个PCM流的质量取决与两方面：

* **采样频率** 
* **采样深度(bit depth)**

在ALSA的PCM接口当中，PCM泛指所有离散时间内的离散采样音频信号。


# 1. 概述

## 1.1 PCM设备的两种类型

PCM设备（内核level）可以简单地分为"输出(playback)"和"输入(capture)"两类。其中的方向是站在ALSA应用的角度而言，即：

* PCM输出设备接收从ALSA应用传入的数据，再到mixer(CTL设备)，然后路由至输出socket,外接具有DAC的声卡设备(或者路由到别的PCM输入设备)
* PCM输入设备将数据通过socket从具有ADC的声卡设备（或者经由mixer从别的PCM输出设备）读入，传入ALSA应用

  （注意：这里的*PCM XX设备*指的都是内核level的设备* 而*声卡设备*指的是通过socket与SOC相连的物理设备）

## 1.2 PCM设备和ALSA应用的ring buffer

PCM设备与ALSA应用间的传输是通过DMA方式进行传输（具体参见[这里](http://www.linuxjournal.com/node/6735/print)）。在kernel space和user space，各有一个ring buffer用以存储采样信号，前者是由内核的PCM设备维护(一个指向*当前*正在读/写的sample)，后者是由ALSA应用（利用ALSA library）维护(一个指向*上一次*读/写的sample):

* 在playback的时候，ALSA应用通过DMA将buffer中的数据传给PCM设备的buffer
* 在capture的时候，PCM设备通过DMA将buffer中的数据传给ALSA应用的buffer

### 1.2.1 ring buffer - 单位(period, frame, sample)

buffer的size可以通过ALSA library的API进行修改。如果buffer设的太大，那么一次数据的传输需要的延迟会增加。为了解决这个问题，ALSA将buffer分为一系列的**period**(在OSS/Free语境中称为fragment)，然后以period为单位进行数据的传输。

因此，在buffer里有以下几个单位：

* **period** 一个period当中存储多个多个frame
* **frame** 一个frame中存储一个或多个同一时间采集的sample。多个ADC/DAC用于同一时间采集/转换多个sample，那么这几个同时间被处理的sample组成一个frame。通常，如果一个设别有N个channel，那么它的一个frame等于N个sample
* **sample** 每一个采样得到的数值称为一个sample，它可能是多个字节的，大端或者小端，浮点数或者整数，有符号或者无符号

它们的关系如下图所示：

![ALSA application buffer](/images/alsa/pcm/alsa_app_buffer_i.png)

### 1.2.2 ring buffer - 存取方式(interleaved, non-interleaved)

Ring buffer 有三种存取方式：

1. **Interleaved access**
   
        C0 C1 C2 C3 C0 C1 C2 C3 ....

2. **Non-interleaved access**

        C0 C0 C0 C0 ................ C1 C1 C1 C1 ............. C2 C2 C2 C2 ............... C3 C3 C3 C3 ...........

3. **Complex access**

具体参见 [PCM Ring Buffer](http://www.alsa-project.org/main/index.php/PCM_Ring_Buffer)

# 2. UNIX 环境下的数据传输方式

# 3. 阻塞和非阻塞OPEN

# 4. PCM设备和ALSA应用间的同步

# 5. 错误码

# 6. HW/SW 参数

# 7. STREAM状态

# 8. STREAM同步

# 9. PCM 命名规范


# 引用

[1] [PCM interface](http://www.alsa-project.org/alsa-doc/alsa-lib/pcm.html)

[2] [Introduction to Sound Programming with ALSA](http://www.linuxjournal.com/node/6735/print)

[3] [PCM Ring Buffer](http://www.alsa-project.org/main/index.php/PCM_Ring_Buffer)
